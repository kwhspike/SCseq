old_genes <- rownames(merged_obj)

gene_names <- gene_map$gene_name[
  match(old_genes, gene_map$gene_id)
]

# æ²¡åŒ¹é…åˆ°çš„ï¼Œä¿ç•™åŸ ENSG
gene_names[is.na(gene_names)] <- old_genes[is.na(gene_names)]

# ğŸ”´ å…³é”®ï¼šè®© gene name å”¯ä¸€ï¼ˆGENE, GENE.1, GENE.2ï¼‰
gene_names <- make.unique(gene_names)

# ğŸ”´ åŒé‡ä¿é™©ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰
stopifnot(
  length(gene_names) == length(old_genes),
  !any(duplicated(gene_names))
)

sum(grepl("^ENSG", rownames(merged_obj)))

RenameGenesSeurat_v5 <- function(obj, newnames) {
  RNA <- obj[["RNA"]]
  
  if (nrow(RNA) != length(newnames)) {
    stop("Unequal gene sets: nrow(RNA) != length(newnames)")
  }
  
  rownames(RNA) <- newnames
  obj[["RNA"]] <- RNA
  return(obj)
}
merged_obj1 <- RenameGenesSeurat_v5(merged_obj, gene_names)
